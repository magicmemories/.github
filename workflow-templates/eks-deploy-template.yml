name: Python package

# TESTING
# This workflow configuration runs the jobs on each push and pull requests against the master branch.
on:  
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
  

 ####################################################### BUILD APPLICATION ##################################################################################

jobs:
  build_and_test:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/master'
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2 

      # RUN TESTS : using own test file for now
      - name: Docker RUN test_suite
        run: |
          export DOCKER_BUILDKIT=1 && docker build . --target test_suite
          
  publish_image:
    runs-on: ubuntu-latest
    needs: build_and_test
    if: github.ref != 'refs/heads/master'
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2     
      - name: Docker Login
        # You may pin to the exact commit or the version.
        # uses: docker/login-action@f3364599c6aa293cdc2b8391b1b56d0c30e45c8a
        uses: docker/login-action@v1.8.0
        with:
          # Server address of Docker registry. If not set then will default to Docker Hub
          registry: http://docker.magicmemories.com
          # Username used to log against the Docker registry
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          # Password or personal access token used to log against the Docker registry
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          # Log out from the Docker registry at the end of a job
          logout: false

      - name: Docker Setup Buildx
        # You may pin to the exact commit or the version.
        # uses: docker/setup-buildx-action@154c24e1f33dbb5865a021c99f1318cfebf27b32
        uses: docker/setup-buildx-action@v1
        id: buildx
        with:
          install: true

      - name: Docker Build
        run: |
            docker build --target app -t docker.magicmemories.com/${{ github.event.repository.name }}:${{ github.sha }} --build-arg NEXUS_CREDS=${{ secrets.NEXUS_CREDS}} --push .
      
########################################################## DEPLOY TO TEST ENVIRONMENT ##############################################################################

  
  deploy_to_test_env:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    environment:
      name: environment_test
    steps:
      - uses: actions/checkout@v2
      - name: Docker Login
          # You may pin to the exact commit or the version.
          # uses: docker/login-action@f3364599c6aa293cdc2b8391b1b56d0c30e45c8a
        uses: docker/login-action@v1.8.0
        with:
          # Server address of Docker registry. If not set then will default to Docker Hub
          registry: https://docker.magicmemories.com
          # Username used to log against the Docker registry
          username: ${{ secrets.NEXUS_USERNAME }}
          # Password or personal access token used to log against the Docker registry
          password: ${{ secrets.NEXUS_PASSWORD }}
          # Log out from the Docker registry at the end of a job
          logout: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Decrypt SOPS Secrets
          # You may pin to the exact commit or the version.
          # uses: rmb938/sops-decrypt-action@b566d1bdf324e157c70890efda8192fd59f18945
        uses: rmb938/sops-decrypt-action@0.1.0
        with:
          # The directory that contains sops encrypted secrets
          secrets-directory: helm/test

      - name: Docker Build
        run: |
            docker build --target app -t docker.magicmemories.com/${{ github.event.repository.name }}:${{ github.sha }} --build-arg NEXUS_CREDS=${{ secrets.NEXUS_CREDS}} --push .
     
      - name: EKS Helm Deploy
        # You may pin to the exact commit or the version.
        # uses: peymanmortazavi/eks-helm-deploy@83f4abceabc33da212caebf906cf82c05f1fb210
        uses: peymanmortazavi/eks-helm-deploy@v2.1 
        with:
          # AWS credentials used to login to eks.
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS credentials used to login to eks.
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # AWS region to use (default: us-west-2)
          aws-region: us-west-2
          # EKS cluster name.
          cluster-name: test-01
          # EKS cluster admin role arn.
          cluster-role-arn: arn:aws:iam::482780835707:role/jenkins-access-to-eks
          # Comma separates list of helm values files.
          config-files: helm/values.yaml, helm/test/decrypted/secrets.test.yaml, helm/values.test.yaml
          # Kubernetes namespace to use.
          namespace: test
          # Name of the helm deploy.
          name: ${{ github.event.repository.name }}
          # The path of the chart.
          chart-path: helm/
          values: image_tag=${{ github.sha }}

########################################################## DEPLOY TO UAT ENVIRONMENT ##############################################################################


  deploy_to_uat_env:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: deploy_to_test_env
    environment: 
      name: environment_uat
    steps:
        - uses: actions/checkout@v2
        - name: Docker Login
          # You may pin to the exact commit or the version.
          # uses: docker/login-action@f3364599c6aa293cdc2b8391b1b56d0c30e45c8a
          uses: docker/login-action@v1.8.0
          with:
            # Server address of Docker registry. If not set then will default to Docker Hub
            registry: http://docker.magicmemories.com
            # Username used to log against the Docker registry
            username: ${{ secrets.NEXUS_USERNAME }}
            # Password or personal access token used to log against the Docker registry
            password: ${{ secrets.NEXUS_PASSWORD }}
            # Log out from the Docker registry at the end of a job
            logout: false

          - name: Configure AWS Credentials
            uses: aws-actions/configure-aws-credentials@v1
            with:
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: us-west-2

          - name: Decrypt SOPS Secrets
              # You may pin to the exact commit or the version.
              # uses: rmb938/sops-decrypt-action@b566d1bdf324e157c70890efda8192fd59f18945
            uses: rmb938/sops-decrypt-action@0.1.0
            with:
              # The directory that contains sops encrypted secrets
              secrets-directory: helm/uat

          - name: Docker Build
            run: |
                docker build --target app -t docker.magicmemories.com/${{ github.event.repository.name }}:${{ github.sha }} --build-arg NEXUS_CREDS=${{ secrets.NEXUS_CREDS}} --push .
      
          - name: EKS Helm Deploy
            # You may pin to the exact commit or the version.
            # uses: peymanmortazavi/eks-helm-deploy@83f4abceabc33da212caebf906cf82c05f1fb210
            uses: peymanmortazavi/eks-helm-deploy@v2.1
            with:
              # AWS credentials used to login to eks.
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              # AWS credentials used to login to eks.
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              # AWS region to use (default: us-west-2)
              aws-region: us-west-2
              # EKS cluster name.
              cluster-name: uat-01
              # EKS cluster admin role arn.
              cluster-role-arn: arn:aws:iam::482780835707:role/jenkins-access-to-eks
              # Comma separates list of helm values files.
              config-files: helm/values.yaml, helm/uat/decrypted/secrets.uat.yaml, helm/values.uat.yaml
              # Kubernetes namespace to use.
              namespace: uat
              # Name of the helm deploy.
              name: githubactions
              # The path of the chart.
              chart-path: helm/
              values: image_tag=${{ github.sha }}